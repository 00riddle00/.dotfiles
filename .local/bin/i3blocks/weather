#!/usr/bin/env bash
# vim:ft=bash:tw=79:sw=2:ts=2:sts=2:et
#------------------------------------------------------------------------------
# Author: 00riddle00 (Tomas Giedraitis)
# Date:   2024-09-29 18:29:20 EEST
# Path:   ~/.local/bin/i3blocks/weather
# URL:    https://github.com/00riddle00/dotfiles
#------------------------------------------------------------------------------
#*
# ...
#**

#* USAGE:
#*   ${0}
#*
#*   The script is designed to be run by i3blocks status bar manager, but can
#*   be run from the terminal as well.
#**
title="i3blocks_weather"

case "$BLOCK_BUTTON" in
  1)  getforecast && showweather;
      i3-msg -q "exec --no-startup-id urxvt -name $title -hold -e curl wttr.in/Vilnius" ;;
  3) pid=$(ps aux | grep "urxvt \-name $title" | awk '{print $2}');
     kill -9 $pid;
esac

getforecast() {
    ping -q -c 1 8.8.8.8 >/dev/null || exit 1
    curl -s "wttr.in/Vilnius" > "$HOME/.local/share/weatherreport" || exit 1;
}

showweather() {
    sed '4q;d' "$HOME/.local/share/weatherreport" |
    grep -o "m\\([-+]\\)*[0-9]\\+" |
    sed -e 1b -e '$!d' | tr '\n|m' ' ' |
    awk '{print $1 "°" ".." $2 "°"}'
}

getforecast && showweather

